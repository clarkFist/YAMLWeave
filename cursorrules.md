## 1. 系统概述

YAMLWeave是一款专用于C代码自动插桩的工具，支持两种工作模式：传统模式和分离模式。该工具提供图形用户界面，允许用户选择项目目录和YAML配置文件，执行自动插桩操作，并在日志区域显示处理结果。

## 2. 功能需求

### 2.1 基本功能

1. **工作模式**：
   - **传统模式**：直接从C代码注释中的code字段提取桩代码
   - **分离模式**：通过锚点标识与YAML配置文件关联，实现桩代码与源代码分离

2. **主要操作流程**：
   - 选择项目目录（包含源代码的目录）
   - 选择YAML配置文件（可选，用于分离模式）
   - 点击"扫描并插入"按钮执行自动插桩操作
   - 在日志区域显示处理过程和结果

### 2.2 详细功能

1. **项目目录处理**：
   - 扫描指定目录中的所有.c和.h文件
   - 自动创建时间戳标记的备份目录（格式：源目录名_backup_YYYYMMDD_HHMMSS）
   - 自动创建时间戳标记的插桩结果目录（格式：源目录名_stubbed_YYYYMMDD_HHMMSS）
   - 在插桩结果目录中保持原始目录结构，仅对需要修改的文件进行处理

2. **YAML配置处理**：
   - 解析YAML配置文件，提取测试用例、步骤和代码段
   - 支持多级嵌套的测试用例组织结构
   - 支持YAML中的字面块标量格式（使用"|"符号）和列表格式
   - 提供示例YAML配置文件生成功能

3. **代码插桩处理**：
   - 识别C代码中的锚点标识或传统注释
   - 根据锚点或注释提取对应的桩代码
   - 在指定位置插入桩代码，并添加"// 通过桩插入"标识
   - 保持桩代码的缩进与原代码一致
   - 支持多行桩代码的插入

4. **日志记录**：
   - 记录处理过程的详细信息
   - 保存执行日志到固定目录
   - 显示历史执行统计信息
   - 支持不同级别的日志（信息、警告、错误、成功等）

## 3. 输入规范

### 3.1 C文件锚点规范

1. **传统模式锚点格式**：
   ```c
   // TC001 STEP1: 数据边界检查
   // code: if (data < 0 || data > 100) { log_error("无效数据: %d", data); return; }
   ```

2. **分离模式锚点格式**：
   ```c
   // TC001 STEP1 segment1
   ```

3. **锚点组成部分**：
   - **测试用例ID**：以"TC"开头，后跟数字（如TC001）
   - **步骤ID**：以"STEP"开头，后跟数字（如STEP1）
   - **代码段ID**（分离模式）：自定义标识符（如segment1）

### 3.2 YAML配置文件格式

YAML配置文件支持两种格式：

1. **字面块格式**：
```yaml
TC001:
  STEP1:
    segment1: |
      if (data < 0 || data > 100) {
          printf("无效数据: %d\n", data);
          return;
      }
```

2. **列表格式**：
```yaml
TC001:
  STEP1:
    segment1:
      - if (data < 0 || data > 100) {
      - "    printf(\"无效数据: %d\\n\", data);"
      - "    return;"
      - }
```

## 4. 输出规范

### 4.1 插桩结果格式

1. **传统模式插桩结果**：
   ```c
   void process_data(int data) {
       // TC001 STEP1: 数据边界检查
       // code: if (data < 0 || data > 100) { log_error("无效数据: %d", data); return; }
       if (data < 0 || data > 100) {  // 通过桩插入
           log_error("无效数据: %d", data);  // 通过桩插入
           return;  // 通过桩插入
       }  // 通过桩插入
       perform_data_processing(data);
   }
   ```

2. **分离模式插桩结果**：
   ```c
   void process_data(int data) {
       // TC001 STEP1 segment1
       if (data < 0 || data > 100) {  // 通过桩插入
           log_error("无效数据: %d", data);  // 通过桩插入
           return;  // 通过桩插入
       }  // 通过桩插入
       perform_data_processing(data);
   }
   ```

### 4.2 日志输出格式

1. **UI日志输出格式**：
   - `[信息] 消息内容` - 普通信息
   - `[警告] 消息内容` - 警告信息
   - `[错误] 消息内容` - 错误信息
   - `[成功] 消息内容` - 成功信息
   - `[找到] 消息内容` - 找到锚点
   - `[配置] 消息内容` - 配置相关信息
   - `[插入] 消息内容` - 插入桩代码
   - `[跳过] 消息内容` - 跳过锚点

2. **统计信息输出**：
   ```
   ====== 处理完成，详细统计 ======
   [统计] 总扫描文件数: X
   [统计] 更新的文件数: Y
   [统计] 插入的桩点数: Z
   [统计] 文件更新率: XX.X%
   [统计] 平均每文件桩点: YY.Y
   ================================
   ```

3. **日志文件输出**：
   - 记录时间戳、模块名、日志级别和消息内容
   - 保存在logs目录下的yamlweave.log文件中
   - 格式：`时间戳 - 模块名 - 日志级别 - 消息内容`

### 4.3 执行日志格式
```
===== 执行日志：时间戳 =====
项目目录: 路径
备份目录: 路径
插桩结果目录: 路径

----- 执行统计 -----
扫描文件数: X
更新文件数: Y
插入桩点数: Z
失败文件数: W

----- 用例统计 -----
TC001: 
  - 总锚点数: A
  - 已插入锚点数: B
  - 插入率: C%
  - 所在文件: 文件1, 文件2, ...
  
TC002:
  - 总锚点数: D
  - 已插入锚点数: E
  - 插入率: F%
  - 所在文件: 文件3, 文件4, ...

[其他测试用例统计...]

----- 文件详情 -----
文件1:
  - 包含锚点: TC001(STEP1, STEP2), TC003(STEP1)
  - 插入桩点数: G
  - 更新状态: 成功/失败
  
文件2:
  - 包含锚点: TC002(STEP1), TC004(STEP2)
  - 插入桩点数: H
  - 更新状态: 成功/失败
  
[其他文件详情...]
```

## 5. 用户界面

### 5.1 主界面布局

1. **项目目录选择区域**：
   - 文本输入框：显示选择的项目目录路径
   - 浏览按钮：打开文件夹选择对话框

2. **YAML配置文件选择区域**：
   - 文本输入框：显示选择的YAML配置文件路径
   - 浏览按钮：打开文件选择对话框

3. **操作按钮区域**：
   - "扫描并插入"按钮：执行插桩操作

4. **进度显示区域**：
   - 进度条：显示整体处理进度
   - 进度标签：显示当前处理状态
   - 进度详情：显示已处理文件数/总文件数

5. **日志区域**：
   - 滚动文本区：显示处理过程中的日志信息
   - 按不同类型信息显示不同颜色

6. **状态栏**：
   - 显示当前状态信息

### 5.2 操作流程

1. 启动工具
2. 选择包含源代码的项目目录
3. （可选）选择包含桩代码的YAML配置文件
4. 点击"扫描并插入"按钮
5. 查看处理进度和日志输出
6. 处理完成后，查看统计信息和结果目录

## 6. 辅助功能

1. **插桩结果保存机制**：
   - 系统自动在源码目录的同级目录下创建时间戳标记的备份目录（格式：源目录名_backup_YYYYMMDD_HHMMSS）
   - 同时生成时间戳标记的插桩结果目录（格式：源目录名_stubbed_YYYYMMDD_HHMMSS）
   - 完整保留原始文件结构，仅针对包含锚点的文件执行处理操作
   - 确保原始源代码文件不受任何影响，有效避免对原始代码的意外修改风险

2. **示例功能**：
   - 自动创建示例文件和示例配置
   - 提供测试用例演示工具功能
   - 支持生成基础测试用例和高级测试用例

3. **日志管理**：
   - 保存执行日志到固定目录
   - 显示历史执行统计信息
   - 支持多级别日志记录

4. **错误处理**：
   - 优雅处理各种异常情况
   - 提供用户友好的错误提示
   - 支持模块导入失败时的降级处理
